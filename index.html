<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Busultan Trading</title>

  <style>
    :root {
      --bg-main: #050914;
      --bg-card: rgba(15, 20, 40, 0.92);
      --text-main: #e8ecff;
      --accent: #22c55e;
      --accent2: #0ea5e9;
    }

    body.theme-light {
      --bg-main: #f0f4ff;
      --bg-card: rgba(255, 255, 255, 0.92);
      --text-main: #0f172a;
      --accent: #16a34a;
      --accent2: #0284c7;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", system-ui, sans-serif;
      background: var(--bg-main)
        url("https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1600&q=80")
        center/cover fixed;
      color: var(--text-main);
    }

    #app {
      max-width: 1150px;
      margin: 30px auto 50px;
      padding: 20px;
      backdrop-filter: blur(14px);
      background: linear-gradient(
        145deg,
        rgba(5, 9, 20, 0.9),
        rgba(5, 12, 30, 0.88)
      );
      border-radius: 22px;
      box-shadow: 0 20px 55px rgba(0, 0, 0, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    body.theme-light #app {
      background: linear-gradient(
        145deg,
        rgba(241, 245, 249, 0.96),
        rgba(226, 232, 240, 0.96)
      );
      box-shadow: 0 10px 35px rgba(15, 23, 42, 0.18);
      border-color: rgba(148, 163, 184, 0.45);
    }

    /* HEADER */

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 22px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo svg {
      width: 60px;
      height: 60px;
      filter: drop-shadow(0 0 12px rgba(0, 255, 255, 0.4));
    }

    .logoText {
      font-size: 26px;
      font-weight: 700;
      background: linear-gradient(90deg, #00eaff, #b37bff);
      -webkit-background-clip: text;
      color: transparent;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .pill {
      padding: 8px 16px;
      border-radius: 999px;
      border: none;
      background: rgba(148, 163, 184, 0.2);
      color: var(--text-main);
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill:hover {
      background: rgba(148, 163, 184, 0.35);
    }

    /* NAV TABS */

    .nav {
      display: flex;
      gap: 14px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 9px 18px;
      border-radius: 999px;
      background: rgba(148, 163, 184, 0.16);
      cursor: pointer;
      font-size: 14px;
      border: 1px solid transparent;
      color: var(--text-main);
      white-space: nowrap;
    }

    .nav-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border-color: rgba(15, 23, 42, 0.4);
      color: white;
    }

    /* PAGES */

    .page {
      display: none;
      padding: 20px;
      border-radius: 18px;
      background: var(--bg-card);
      box-shadow: 0 0 20px rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(148, 163, 184, 0.35);
      margin-bottom: 5px;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .page h2 {
      margin-top: 0;
      font-size: 21px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    /* POSITION CALCULATOR */

    .calc-container {
      margin-top: 15px;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 18px;
      padding: 18px 18px 20px;
      box-shadow: 0 0 22px rgba(0, 0, 0, 0.55);
    }

    body.theme-light .calc-container {
      background: rgba(255, 255, 255, 0.96);
    }

    .calc-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px 18px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .field.full {
      grid-column: 1 / -1;
    }

    .field label {
      font-size: 13px;
      opacity: 0.85;
    }

    .field input,
    .field select,
    .log-form textarea {
      padding: 9px 11px;
      font-size: 14px;
      border-radius: 11px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
    }

    body.theme-light .field input,
    body.theme-light .field select,
    body.theme-light .log-form textarea {
      background: rgba(255, 255, 255, 0.97);
      color: #0f172a;
      border-color: rgba(148, 163, 184, 0.9);
    }

    .field input:focus,
    .field select:focus,
    .log-form textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.45);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      color: white;
      padding: 11px 20px;
      border-radius: 12px;
      font-size: 15px;
      cursor: pointer;
      font-weight: 600;
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.6);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(0, 0, 0, 0.7);
    }

    .results,
    .risk-results {
      margin-top: 22px;
      background: rgba(15, 23, 42, 0.9);
      padding: 18px;
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.45);
    }

    body.theme-light .results,
    body.theme-light .risk-results {
      background: rgba(248, 250, 252, 0.98);
    }

    .results h3,
    .risk-results h3 {
      margin: 0 0 12px;
      font-size: 17px;
    }

    .res-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
    }

    .res-item {
      padding: 10px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 13px;
    }

    body.theme-light .res-item {
      background: white;
    }

    .res-item label {
      display: block;
      margin-bottom: 4px;
      opacity: 0.7;
    }

    .res-item span {
      font-size: 15px;
      font-weight: 600;
    }

    .hidden {
      display: none;
    }

    /* RISK ENGINE */

    .risk-container {
      background: rgba(15, 23, 42, 0.88);
      padding: 18px;
      border-radius: 18px;
      margin-top: 12px;
      box-shadow: 0 0 22px rgba(0, 0, 0, 0.6);
    }

    body.theme-light .risk-container {
      background: rgba(255, 255, 255, 0.98);
    }

    .risk-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 14px 18px;
    }

    /* TRADE LOG */

    .log-container {
      background: rgba(15, 23, 42, 0.9);
      padding: 18px;
      border-radius: 18px;
      box-shadow: 0 0 22px rgba(0, 0, 0, 0.65);
    }

    body.theme-light .log-container {
      background: rgba(255, 255, 255, 0.98);
    }

    .log-form {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px 16px;
    }

    .log-form .full {
      grid-column: 1 / -1;
    }

    .log-form textarea {
      resize: vertical;
      min-height: 70px;
    }

    .log-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      font-size: 13px;
    }

    .log-table th {
      background: rgba(148, 163, 184, 0.16);
      padding: 8px;
      text-align: center;
    }

    .log-table td {
      padding: 7px 6px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.4);
      text-align: center;
      word-break: break-word;
    }

    .log-table tr.win td {
      color: #22c55e;
    }

    .log-table tr.loss td {
      color: #ef4444;
    }

    .log-table tr.be td {
      color: #eab308;
    }

    .log-table button {
      background: #ef4444;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 11px;
    }

    /* BACKTESTING */

    .back-container {
      background: rgba(15, 23, 42, 0.9);
      padding: 18px;
      border-radius: 18px;
      margin-top: 12px;
      box-shadow: 0 0 22px rgba(0, 0, 0, 0.6);
    }

    body.theme-light .back-container {
      background: rgba(255, 255, 255, 0.98);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-top: 14px;
    }

    .stat-box {
      padding: 12px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    body.theme-light .stat-box {
      background: white;
    }

    .stat-box label {
      display: block;
      font-size: 12px;
      opacity: 0.75;
      margin-bottom: 5px;
    }

    .stat-box span {
      font-size: 16px;
      font-weight: 600;
    }

    .pair-performance {
      margin-top: 12px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.45);
      font-size: 13px;
    }

    body.theme-light .pair-performance {
      background: white;
    }

    canvas {
      width: 100%;
      max-width: 100%;
      margin-top: 10px;
      background: rgba(15, 23, 42, 0.96);
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    body.theme-light canvas {
      background: white;
    }

    /* RESPONSIVE */

    @media (max-width: 900px) {
      #app {
        margin: 10px;
        padding: 14px;
      }

      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .calc-grid,
      .risk-grid,
      .log-form,
      .res-grid,
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body class="theme-dark">
  <div id="app">
    <!-- HEADER -->
    <div class="header">
      <div class="logo">
        <svg viewBox="0 0 200 200">
          <defs>
            <radialGradient id="cyberGlow" cx="50%" cy="50%" r="50%">
              <stop offset="0%" stop-color="#00eaff" stop-opacity="0.9" />
              <stop offset="100%" stop-color="#0a0f1f" stop-opacity="0" />
            </radialGradient>
            <linearGradient id="bullCandle" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#00f5ff" />
              <stop offset="100%" stop-color="#00b3c6" />
            </linearGradient>
            <linearGradient id="bearCandle" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#c770ff" />
              <stop offset="100%" stop-color="#9236ff" />
            </linearGradient>
            <linearGradient id="trendLine" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#00eaff" />
              <stop offset="100%" stop-color="#00a7ff" />
            </linearGradient>
          </defs>

          <circle cx="100" cy="100" r="90" fill="url(#cyberGlow)" />
          <circle
            cx="100"
            cy="100"
            r="80"
            stroke="#00eaff"
            stroke-width="2"
            fill="transparent"
            opacity="0.5"
          />

          <polyline
            points="40,130 70,110 110,140 150,80"
            fill="none"
            stroke="url(#trendLine)"
            stroke-width="6"
            stroke-linecap="round"
          />

          <rect
            x="55"
            y="85"
            width="18"
            height="45"
            rx="4"
            fill="url(#bullCandle)"
          />
          <rect x="63" y="70" width="2" height="15" fill="#00eaff" />

          <rect
            x="120"
            y="95"
            width="18"
            height="35"
            rx="4"
            fill="url(#bearCandle)"
          />
          <rect x="128" y="130" width="2" height="15" fill="#c770ff" />
        </svg>
        <span class="logoText">BUSULTAN</span>
      </div>

      <div class="controls">
        <button id="langToggle" class="pill">AR</button>
        <button id="themeToggle" class="pill">ðŸŒ™</button>
      </div>
    </div>

    <!-- NAVIGATION -->
    <div class="nav">
      <div class="nav-btn active" data-page="pos">Position Sizing</div>
      <div class="nav-btn" data-page="risk">Risk Engine</div>
      <div class="nav-btn" data-page="log">Trade Log</div>
      <div class="nav-btn" data-page="back">Backtesting</div>
    </div>

    <!-- PAGES -->

    <!-- POSITION -->
    <div id="pos" class="page active">
      <h2>Position Sizing Calculator</h2>

      <div class="calc-container">
        <div class="calc-grid">
          <div class="field">
            <label>Account Balance (USD)</label>
            <input id="balance" type="number" placeholder="Example: 10000" />
          </div>

          <div class="field">
            <label>Risk %</label>
            <input id="risk" type="number" placeholder="1 = 1%" />
          </div>

          <div class="field">
            <label>Entry Price</label>
            <input id="entry" type="number" placeholder="1.08500" />
          </div>

          <div class="field">
            <label>Stop Loss Price (SL)</label>
            <input
              id="sl"
              type="number"
              placeholder="If empty, auto from pips"
            />
          </div>

          <div class="field">
            <label>Stop Distance (Pips)</label>
            <input id="stopPips" type="number" placeholder="20" />
          </div>

          <div class="field">
            <label>Trade Direction</label>
            <select id="direction">
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>

          <div class="field full">
            <label>Symbol</label>
            <select id="symbol">
              <option value="EURUSD" data-group="major">EURUSD</option>
              <option value="GBPUSD" data-group="major">GBPUSD</option>
              <option value="USDJPY" data-group="jpy">USDJPY</option>
              <option value="GBPJPY" data-group="jpy">GBPJPY</option>
              <option value="AUDCAD" data-group="cross">AUDCAD</option>
              <option value="XAUUSD" data-group="metals">XAUUSD (Gold)</option>
              <option value="WTI" data-group="oil">WTI Oil</option>
              <option value="US100" data-group="indices">US100 Nasdaq</option>
            </select>
          </div>

          <div class="field">
            <label>Leverage</label>
            <input id="leverage" type="number" value="500" />
          </div>

          <div class="field full">
            <button id="calcBtn" class="btn-primary">Calculate</button>
          </div>
        </div>

        <div class="results hidden" id="resultsBox">
          <h3>Results</h3>
          <div class="res-grid">
            <div class="res-item">
              <label>Lot Size</label>
              <span id="lotSize">0.00</span>
            </div>

            <div class="res-item">
              <label>Risk Amount ($)</label>
              <span id="riskAmount">0</span>
            </div>

            <div class="res-item">
              <label>Pip Distance</label>
              <span id="pipDistance">0</span>
            </div>

            <div class="res-item">
              <label>Margin Required</label>
              <span id="marginRequired">0</span>
            </div>

            <div class="res-item">
              <label>Notional</label>
              <span id="notional">0</span>
            </div>

            <div class="res-item">
              <label>TP1 (2Ã— Risk)</label>
              <span id="tp1">0</span>
            </div>

            <div class="res-item">
              <label>TP2 (3Ã— Risk)</label>
              <span id="tp2">0</span>
            </div>

            <div class="res-item">
              <label>TP3 (4Ã— Risk)</label>
              <span id="tp3">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- RISK ENGINE -->
    <div id="risk" class="page">
      <h2>Risk Engine</h2>

      <div class="risk-container">
        <div class="risk-grid">
          <div class="field">
            <label>Account Balance (USD)</label>
            <input id="r_balance" type="number" placeholder="10000" />
          </div>

          <div class="field">
            <label>Risk % per Trade</label>
            <input id="r_riskPct" type="number" placeholder="1" />
          </div>

          <div class="field">
            <label>Entry Price</label>
            <input id="r_entry" type="number" placeholder="1.08500" />
          </div>

          <div class="field">
            <label>Stop Loss Price (SL)</label>
            <input
              id="r_sl"
              type="number"
              placeholder="Leave empty to use pips"
            />
          </div>

          <div class="field">
            <label>Stop Distance (Pips)</label>
            <input id="r_stopPips" type="number" placeholder="20" />
          </div>

          <div class="field">
            <label>Direction</label>
            <select id="r_direction">
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
            </select>
          </div>

          <div class="field full">
            <label>Symbol</label>
            <select id="r_symbol">
              <option value="EURUSD" data-group="major">EURUSD</option>
              <option value="USDJPY" data-group="jpy">USDJPY</option>
              <option value="XAUUSD" data-group="metals">XAUUSD</option>
              <option value="WTI" data-group="oil">WTI</option>
              <option value="US100" data-group="indices">US100</option>
            </select>
          </div>

          <div class="field full">
            <button id="r_calcBtn" class="btn-primary">
              Calculate Risk Engine
            </button>
          </div>
        </div>

        <div id="r_results" class="risk-results hidden">
          <h3>Risk Analysis</h3>
          <div class="res-grid">
            <div class="res-item">
              <label>Risk Amount ($)</label>
              <span id="r_riskAmount">0</span>
            </div>
            <div class="res-item">
              <label>Pip Distance</label>
              <span id="r_pipDistance">0</span>
            </div>
            <div class="res-item">
              <label>Lot Size</label>
              <span id="r_lotSize">0</span>
            </div>
            <div class="res-item">
              <label>Reward (TP1)</label>
              <span id="r_reward1">0</span>
            </div>
            <div class="res-item">
              <label>Reward (TP2)</label>
              <span id="r_reward2">0</span>
            </div>
            <div class="res-item">
              <label>Reward (TP3)</label>
              <span id="r_reward3">0</span>
            </div>
            <div class="res-item">
              <label>R:R (TP1)</label>
              <span id="r_rr1">0</span>
            </div>
            <div class="res-item">
              <label>R:R (TP2)</label>
              <span id="r_rr2">0</span>
            </div>
            <div class="res-item">
              <label>R:R (TP3)</label>
              <span id="r_rr3">0</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TRADE LOG -->
    <div id="log" class="page">
      <h2>Trade Log</h2>

      <div class="log-container">
        <div class="log-form">
          <div class="field">
            <label>Symbol</label>
            <input id="log_symbol" placeholder="EURUSD" />
          </div>

          <div class="field">
            <label>Direction</label>
            <select id="log_direction">
              <option value="Buy">Buy</option>
              <option value="Sell">Sell</option>
            </select>
          </div>

          <div class="field">
            <label>Entry Price</label>
            <input id="log_entry" type="number" placeholder="Entry" />
          </div>

          <div class="field">
            <label>Stop Loss</label>
            <input id="log_sl" type="number" placeholder="SL" />
          </div>

          <div class="field">
            <label>TP1</label>
            <input id="log_tp1" type="number" />
          </div>

          <div class="field">
            <label>TP2</label>
            <input id="log_tp2" type="number" />
          </div>

          <div class="field">
            <label>TP3</label>
            <input id="log_tp3" type="number" />
          </div>

          <div class="field">
            <label>Result</label>
            <select id="log_result">
              <option value="Win">Win</option>
              <option value="Loss">Loss</option>
              <option value="BE">Break Even</option>
            </select>
          </div>

          <div class="field full">
            <label>Notes</label>
            <textarea
              id="log_notes"
              placeholder="Reason for entry"
              rows="3"
            ></textarea>
          </div>

          <div class="field full">
            <button id="log_add" class="btn-primary">Add Trade</button>
          </div>
        </div>

        <h3 style="margin-top: 18px">Saved Trades</h3>

        <div style="margin-bottom: 8px; display: flex; gap: 8px">
          <button id="log_export" class="pill">Export CSV</button>
          <button
            id="log_clear"
            class="pill"
            style="background: #b91c1c; color: white"
          >
            Clear All
          </button>
        </div>

        <table class="log-table">
          <thead>
            <tr>
              <th>Symbol</th>
              <th>Dir</th>
              <th>Entry</th>
              <th>SL</th>
              <th>TP1</th>
              <th>TP2</th>
              <th>TP3</th>
              <th>Result</th>
              <th>Notes</th>
              <th>Delete</th>
            </tr>
          </thead>
          <tbody id="log_body"></tbody>
        </table>
      </div>
    </div>

    <!-- BACKTESTING -->
    <div id="back" class="page">
      <h2>Backtesting & Performance Analytics</h2>

      <div class="back-container">
        <button id="back_refresh" class="btn-primary">Refresh Backtest</button>

        <div class="stats-grid">
          <div class="stat-box">
            <label>Total Trades</label>
            <span id="b_total">0</span>
          </div>

          <div class="stat-box">
            <label>Win Rate %</label>
            <span id="b_winrate">0%</span>
          </div>

          <div class="stat-box">
            <label>Net Profit</label>
            <span id="b_netprofit">0</span>
          </div>

          <div class="stat-box">
            <label>Profit Factor</label>
            <span id="b_pf">0</span>
          </div>

          <div class="stat-box">
            <label>Max Drawdown</label>
            <span id="b_dd">0</span>
          </div>

          <div class="stat-box">
            <label>Avg R:R</label>
            <span id="b_rr">0</span>
          </div>
        </div>

        <h3 style="margin-top: 16px">Equity Curve</h3>
        <canvas id="equityChart" height="160"></canvas>

        <h3 style="margin-top: 16px">Pair Performance</h3>
        <div id="pair_stats" class="pair-performance"></div>
      </div>
    </div>
  </div>

  <script>
    /* NAVIGATION BETWEEN PAGES */
    document.querySelectorAll(".nav-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".nav-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");

        const page = btn.dataset.page;
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        document.getElementById(page).classList.add("active");
      });
    });

    /* THEME TOGGLE */
    const themeBtn = document.getElementById("themeToggle");
    themeBtn.addEventListener("click", () => {
      document.body.classList.toggle("theme-light");
      if (document.body.classList.contains("theme-light")) {
        themeBtn.textContent = "â˜€ï¸";
      } else {
        themeBtn.textContent = "ðŸŒ™";
      }
    });

    /* SIMPLE LANGUAGE TOGGLE (DIR + LANG ONLY) */
    const langBtn = document.getElementById("langToggle");
    langBtn.addEventListener("click", () => {
      const current = document.documentElement.lang || "ar";
      const next = current === "ar" ? "en" : "ar";
      document.documentElement.lang = next;
      document.documentElement.dir = next === "ar" ? "rtl" : "ltr";
      langBtn.textContent = next.toUpperCase();
    });

    /* GROUP CONFIG FOR SYMBOLS */

    const groupConfig = {
      major: { pipSize: 0.0001, pipValuePerLot: 10, contractSize: 100000 },
      jpy: { pipSize: 0.01, pipValuePerLot: 9.5, contractSize: 100000 },
      cross: { pipSize: 0.0001, pipValuePerLot: 9, contractSize: 100000 },
      metals: { pipSize: 0.1, pipValuePerLot: 10, contractSize: 100 },
      oil: { pipSize: 0.01, pipValuePerLot: 10, contractSize: 1000 },
      indices: { pipSize: 1, pipValuePerLot: 1, contractSize: 1 },
    };

    function getDecimals(pip) {
      let d = 0;
      while (pip < 1) {
        pip *= 10;
        d++;
      }
      return d;
    }

    /* POSITION CALCULATOR */

    document.getElementById("calcBtn").addEventListener("click", () => {
      const balance = parseFloat(
        document.getElementById("balance").value || "0"
      );
      const riskPct = parseFloat(document.getElementById("risk").value || "0");
      const entry = parseFloat(document.getElementById("entry").value || "0");
      const slInput = document.getElementById("sl").value;
      const stopPips = parseFloat(
        document.getElementById("stopPips").value || "0"
      );
      const direction = document.getElementById("direction").value;
      const leverage = parseFloat(
        document.getElementById("leverage").value || "0"
      );

      const symbolSelect = document.getElementById("symbol");
      const group =
        symbolSelect.options[symbolSelect.selectedIndex].dataset.group;

      if (!balance || !riskPct || !entry) {
        alert("Please fill: balance, risk %, entry.");
        return;
      }

      const cfg = groupConfig[group];
      let sl = parseFloat(slInput);

      if (isNaN(sl)) {
        if (!stopPips || stopPips <= 0) {
          alert("Enter SL price or stop distance in pips.");
          return;
        }
        const autoPipsPrice = stopPips * cfg.pipSize;
        sl = direction === "buy" ? entry - autoPipsPrice : entry + autoPipsPrice;
      }

      const pipDistPrice = Math.abs(entry - sl);
      const pipDistance = pipDistPrice / cfg.pipSize;

      if (pipDistance <= 0) {
        alert("Stop loss distance is zero or negative.");
        return;
      }

      const riskAmount = balance * (riskPct / 100);
      const lotSize = riskAmount / (pipDistance * cfg.pipValuePerLot);

      const notional = lotSize * cfg.contractSize;
      const margin = leverage > 0 ? notional / leverage : 0;

      const dec = getDecimals(cfg.pipSize);
      let tp1, tp2, tp3;

      if (direction === "buy") {
        tp1 = entry + pipDistPrice * 2;
        tp2 = entry + pipDistPrice * 3;
        tp3 = entry + pipDistPrice * 4;
      } else {
        tp1 = entry - pipDistPrice * 2;
        tp2 = entry - pipDistPrice * 3;
        tp3 = entry - pipDistPrice * 4;
      }

      document.getElementById("lotSize").textContent = lotSize.toFixed(2);
      document.getElementById("riskAmount").textContent =
        riskAmount.toFixed(2);
      document.getElementById("pipDistance").textContent =
        pipDistance.toFixed(1);
      document.getElementById("marginRequired").textContent =
        margin.toFixed(2);
      document.getElementById("notional").textContent =
        Math.round(notional).toString();

      document.getElementById("tp1").textContent = tp1.toFixed(dec);
      document.getElementById("tp2").textContent = tp2.toFixed(dec);
      document.getElementById("tp3").textContent = tp3.toFixed(dec);

      document.getElementById("resultsBox").classList.remove("hidden");
    });

    /* RISK ENGINE */

    document.getElementById("r_calcBtn").onclick = () => {
      const balance = parseFloat(
        document.getElementById("r_balance").value || "0"
      );
      const riskPct = parseFloat(
        document.getElementById("r_riskPct").value || "0"
      );
      const entry = parseFloat(document.getElementById("r_entry").value || "0");
      const slInput = document.getElementById("r_sl").value;
      const stopPips = parseFloat(
        document.getElementById("r_stopPips").value || "0"
      );
      const direction = document.getElementById("r_direction").value;

      const symbolSel = document.getElementById("r_symbol");
      const group =
        symbolSel.options[symbolSel.selectedIndex].dataset.group;
      const cfg = groupConfig[group];

      if (!balance || !riskPct || !entry) {
        alert("Please fill: balance, risk %, entry.");
        return;
      }

      let sl = parseFloat(slInput);

      if (isNaN(sl)) {
        if (!stopPips || stopPips <= 0) {
          alert("Enter SL or stop pips.");
          return;
        }
        const p = stopPips * cfg.pipSize;
        sl = direction === "buy" ? entry - p : entry + p;
      }

      const pipDist = Math.abs(entry - sl) / cfg.pipSize;
      const riskAmount = balance * (riskPct / 100);
      const lotSize = pipDist > 0
        ? riskAmount / (pipDist * cfg.pipValuePerLot)
        : 0;

      const priceRisk = Math.abs(entry - sl);
      const reward1 = priceRisk * 2;
      const reward2 = priceRisk * 3;
      const reward3 = priceRisk * 4;

      const rr1 = 2;
      const rr2 = 3;
      const rr3 = 4;

      document.getElementById("r_riskAmount").textContent =
        riskAmount.toFixed(2);
      document.getElementById("r_pipDistance").textContent =
        pipDist.toFixed(1);
      document.getElementById("r_lotSize").textContent = lotSize.toFixed(2);

      document.getElementById("r_reward1").textContent = reward1.toFixed(5);
      document.getElementById("r_reward2").textContent = reward2.toFixed(5);
      document.getElementById("r_reward3").textContent = reward3.toFixed(5);

      document.getElementById("r_rr1").textContent = rr1.toFixed(1);
      document.getElementById("r_rr2").textContent = rr2.toFixed(1);
      document.getElementById("r_rr3").textContent = rr3.toFixed(1);

      document.getElementById("r_results").classList.remove("hidden");
    };

    /* TRADE LOG */

    function loadTrades() {
      const trades = JSON.parse(
        localStorage.getItem("busultan_trades") || "[]"
      );
      const tbody = document.getElementById("log_body");
      tbody.innerHTML = "";

      trades.forEach((t, i) => {
        const row = document.createElement("tr");

        if (t.result === "Win") row.classList.add("win");
        if (t.result === "Loss") row.classList.add("loss");
        if (t.result === "BE") row.classList.add("be");

        row.innerHTML = `
          <td>${t.symbol}</td>
          <td>${t.dir}</td>
          <td>${t.entry}</td>
          <td>${t.sl}</td>
          <td>${t.tp1}</td>
          <td>${t.tp2}</td>
          <td>${t.tp3}</td>
          <td>${t.result}</td>
          <td>${t.notes}</td>
          <td><button data-i="${i}">X</button></td>
        `;

        tbody.appendChild(row);
      });

      tbody.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", () => {
          const idx = parseInt(btn.dataset.i, 10);
          deleteTrade(idx);
        });
      });
    }

    function deleteTrade(i) {
      const trades = JSON.parse(
        localStorage.getItem("busultan_trades") || "[]"
      );
      trades.splice(i, 1);
      localStorage.setItem("busultan_trades", JSON.stringify(trades));
      loadTrades();
    }

    document.getElementById("log_add").onclick = () => {
      const trade = {
        symbol: document.getElementById("log_symbol").value.trim(),
        dir: document.getElementById("log_direction").value,
        entry: document.getElementById("log_entry").value,
        sl: document.getElementById("log_sl").value,
        tp1: document.getElementById("log_tp1").value,
        tp2: document.getElementById("log_tp2").value,
        tp3: document.getElementById("log_tp3").value,
        result: document.getElementById("log_result").value,
        notes: document.getElementById("log_notes").value.trim(),
      };

      const trades = JSON.parse(
        localStorage.getItem("busultan_trades") || "[]"
      );
      trades.push(trade);
      localStorage.setItem("busultan_trades", JSON.stringify(trades));

      loadTrades();
    };

    document.getElementById("log_clear").onclick = () => {
      if (confirm("Delete ALL trades?")) {
        localStorage.removeItem("busultan_trades");
        loadTrades();
      }
    };

    document.getElementById("log_export").onclick = () => {
      const trades = JSON.parse(
        localStorage.getItem("busultan_trades") || "[]"
      );
      if (!trades.length) {
        alert("No trades to export.");
        return;
      }

      let csv =
        "Symbol,Direction,Entry,SL,TP1,TP2,TP3,Result,Notes\n";
      trades.forEach((t) => {
        csv += `${t.symbol},${t.dir},${t.entry},${t.sl},${t.tp1},${t.tp2},${t.tp3},${t.result},"${(t.notes || "")
          .replace(/"/g, '""')
          .replace(/\n/g, " ")}"\n`;
      });

      const file = new Blob([csv], { type: "text/csv" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(file);
      a.download = "trades.csv";
      a.click();
    };

    /* BACKTESTING */

    function runBacktest() {
      const trades = JSON.parse(
        localStorage.getItem("busultan_trades") || "[]"
      );

      let wins = 0,
        losses = 0,
        be = 0;
      let profit = 0;
      let loss = 0;
      let rrList = [];
      let equity = 0;
      let curve = [];
      let pairStats = {};

      trades.forEach((t) => {
        const entry = parseFloat(t.entry || "0");
        const tp1 = parseFloat(t.tp1 || "0");
        const sl = parseFloat(t.sl || "0");

        let res = 0;
        if (t.result === "Win") {
          wins++;
          res = Math.abs(tp1 - entry);
          profit += res;
          equity += res;
          rrList.push(2);
        } else if (t.result === "Loss") {
          losses++;
          res = -Math.abs(entry - sl);
          loss += Math.abs(res);
          equity += res;
          rrList.push(-1);
        } else if (t.result === "BE") {
          be++;
          rrList.push(0);
        }

        curve.push(equity);

        if (!pairStats[t.symbol]) {
          pairStats[t.symbol] = { w: 0, l: 0, be: 0 };
        }
        if (t.result === "Win") pairStats[t.symbol].w++;
        if (t.result === "Loss") pairStats[t.symbol].l++;
        if (t.result === "BE") pairStats[t.symbol].be++;
      });

      const total = trades.length;
      const winrate = total ? ((wins / total) * 100).toFixed(1) : 0;
      const netprofit = profit - loss;
      const profitFactor =
        loss === 0 ? profit.toFixed(2) : (profit / loss).toFixed(2);

      let maxDD = 0;
      let peak = -999999;
      curve.forEach((e) => {
        if (e > peak) peak = e;
        const dd = peak - e;
        if (dd > maxDD) maxDD = dd;
      });

      const rrAvg = rrList.length
        ? (rrList.reduce((a, b) => a + b, 0) / rrList.length).toFixed(2)
        : 0;

      document.getElementById("b_total").textContent = total;
      document.getElementById("b_winrate").textContent = winrate + "%";
      document.getElementById("b_netprofit").textContent =
        netprofit.toFixed(5);
      document.getElementById("b_pf").textContent = profitFactor;
      document.getElementById("b_dd").textContent = maxDD.toFixed(5);
      document.getElementById("b_rr").textContent = rrAvg;

      drawEquityCurve(curve);

      let pHTML = "";
      for (let s in pairStats) {
        pHTML += `<div><b>${s}</b> â†’ W:${pairStats[s].w} L:${pairStats[s].l} BE:${pairStats[s].be}</div>`;
      }
      document.getElementById("pair_stats").innerHTML = pHTML || "No trades yet.";
    }

    function drawEquityCurve(data) {
      const canvas = document.getElementById("equityChart");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (!data.length) return;

      const max = Math.max(...data);
      const min = Math.min(...data);
      const range = max - min || 1;

      const w = canvas.width;
      const h = canvas.height;
      const stepX = data.length > 1 ? w / (data.length - 1) : 0;

      ctx.beginPath();
      ctx.lineWidth = 2;
      ctx.strokeStyle = "#22c55e";

      data.forEach((val, i) => {
        const x = i * stepX;
        const y = h - ((val - min) / range) * h;
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();
    }

    document
      .getElementById("back_refresh")
      .addEventListener("click", runBacktest);

    /* INIT */
    loadTrades();
    runBacktest();
  </script>
</body>
</html>
